# 数理でわかる倉科明日香の天才性
みなさんは『蒼の彼方のフォーリズム』という作品をご存知でしょうか．spriteの製作するアドベンチャーゲームで，現在TVアニメも放映されています．
作中では，反重力粒子によって空を飛ぶことが簡単にできるようになっており，それを搭載した空飛ぶ靴（グラシュ）を用いた競技，フライングサーカスが盛んに行われています．主人公はコーチとして，フライングサーカス（FC）に挑戦するヒロインたちを後押しする形で話は進行します（この文いる？）．
<!-- 図：倉科明日香 -->
FCとは，2人のプレーヤーが空中に浮かんだ一辺300m四方のコースを時計回りに周回していく対戦型の競技です．プレーヤーは，各頂点に設置してあるブイか相手の背中にタッチすることで得点を獲得でき，制限時間終了時により多く得点していたプレーヤーが勝利します．タッチによる得点が，FCをただのレースではなく，激しい空中戦も含んだエキサイティングなスポーツとしています．

この記事では，フライングサーカスにおける高速な飛行法を数値最適化を用いて考えてみたいと思います．

# 設定
- （コースの一辺である）300mの水平な直線を最速で飛行するような飛行ルートを見つける

このようなルートを最速FC曲線と呼ぶことにします．
- 重力は一様で下向き
- ただし，反重力粒子は任意に重力の向きを **反転** できる
- 空気抵抗は無視

# 方針
飛行ルートを小区間に等分し，各小区間は直線運動すると近似します．その上で各小区間を飛行する時間の和を最小にするようなコースを求めれば，そのようなコースは分割数を大きくすればするほど，真の最速FC曲線に近づくと考えられます．
<!-- 図：コースの分割 -->

まずは小区間の飛行を考察します．下図のような直線コースを考えましょう．
<!-- 図：直線コース -->
プレイヤーに働く力は重力だけなので，実現する運動は **等加速度直線運動** になります．したがって，この小区間を飛行するのにかかる時間は次のように計算できます．ただし初速度をv0，重力加速度をgとします．
<!-- 数式：時間 -->
コースが小区間内で上昇するコースの場合は，区間内で重力を反転させる，つまり「上に落ちている」と考えれば最速になることが分かります．このときも飛行時間は上の式で計算できます（ただし，yは距離として考える必要があります）．
<!-- 図：下に落ちる倉科明日香 --><!-- 図：上に落ちる倉科明日香 -->
同様にして小区間の終端での速さも計算できますから，これを次の小区間における初速として計算を繰り返せば，全体の飛行時間が分かります．つまり，全体の飛行時間は各小区間端でのy座標の関数となっています．したがって，解くべき問題は **「全体の飛行時間を最小にするような各小区間端でのy座標を求めよ」** と書けます．

# 数値計算
このような「○○を最小にするような××を求めよ」という問題は一般に **最適化問題** と呼ばれています．最適化問題には様々な解法が考案され，それらを利用するためのフレームワークも整備されています．今回はその中でも **numpy** というpythonから利用できる科学計算スタックを使い，basin-hopping法によって飛行時間を最小化しました．ソースは **後で上げる** にあります．

結果は以下の通りです．まずはコースを10点で分割したものから：
<!-- 図：１０点分割 -->
横軸が水平方向，縦軸が鉛直方向の移動距離で（両方とも単位はm），青線が計算によって得たコースです．一度大きく下降して（40m以上も！）速さを稼いだ後高さを戻しているのが見えますね．このコースで飛行時間は4.8秒です．

区間の分割数を増やしてみましょう．100点分割で計算したものをどうぞ：
<!-- 図：１００点分割 -->
さらに分割数を増やしましょう．10000点分割です（計算に丸2日かかりました）：
<!-- 図：１００００点分割 -->
こいつはすごい．このコースになると飛行時間は4.4秒まで下がります．

# 考察
まず，グラフが大変ぎざぎざしていますね．今回の設定では上昇しようが下降しようが加速するので，ただまっすぐ行くよりも余分に上昇・下降を繰り返した方が高速に進めて時間も短くなるのでしょう．

他にも，どの分割数でもまずは大きく下降して速さを得て，それを生かして残りの区間を駆け抜けるというのが最速であるように見えます．最初に加速すれば最後まで効きますから，このような結果となることには納得がいきます．ですが注目したいのは，分割点を多くするごとに最初に下降する距離が小さくなっていることです（40m->15m->3m）．どうやら，大きく下がるよりも細かく上下を繰り返した方が効率が良いみたいです．また，最初の下降距離だけでなく，その後の振動自体も小さくなっているのが分かります．

ここから次のことが予想できます．

**微小な上下振動を繰り返しながら前進するのが最速FC曲線である**．曲線というより折れ線と言った方がいいかもしれませんね．

この予想を受け入れるとアニメでのある何気ない描写が重大な意味を持ち始めます．次の画像は，ヒロインの一人でありグラシュの操作もままならなかった倉科明日香が飛行訓練している姿を映したアニメ○話のワンシーンです．
<!-- 図：ギザギザ飛行 -->
なんと！ぎざぎざに飛行しています！この後彼女はFCの才能を開花させていくのですが，このシーンは彼女の内に眠る力を既に暗示していたのかもしれません．
